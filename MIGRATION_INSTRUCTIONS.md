# Инструкции по миграции базы данных

## Установка системы уведомлений о непрочитанных сообщениях

Для работы системы уведомлений необходимо выполнить миграцию базы данных:

### 1. Выполните миграцию SQL

```bash
# Подключитесь к вашей базе данных PostgreSQL
psql -h localhost -U postgres -d devduel

# Выполните SQL-команды из файла migrations/add_read_status.sql
\i migrations/add_read_status.sql

# Или выполните команды напрямую:
```

### 2. SQL-команды для миграции

```sql
-- Создаем таблицу для отслеживания прочитанных сообщений
CREATE TABLE IF NOT EXISTS message_reads (
    id SERIAL PRIMARY KEY,
    message_id INTEGER NOT NULL REFERENCES messages(id) ON DELETE CASCADE,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    read_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(message_id, user_id)
);

-- Добавляем индексы для оптимизации
CREATE INDEX IF NOT EXISTS idx_message_reads_user_id ON message_reads(user_id);
CREATE INDEX IF NOT EXISTS idx_message_reads_message_id ON message_reads(message_id);
CREATE INDEX IF NOT EXISTS idx_message_reads_chat_user ON message_reads(message_id, user_id);

-- Добавляем поле last_read_at в chat_participants для отслеживания последнего времени прочтения
ALTER TABLE chat_participants 
ADD COLUMN IF NOT EXISTS last_read_at TIMESTAMP DEFAULT NOW();
```

### 3. Перезапустите сервер

После выполнения миграции перезапустите backend сервер:

```bash
cd backend
npm run dev
```

## Что было добавлено

### Backend изменения:
1. **Новая таблица `message_reads`** - отслеживает какие сообщения прочитал каждый пользователь
2. **Поле `last_read_at`** в `chat_participants` - время последнего прочтения чата пользователем
3. **Новые API эндпоинты**:
   - `POST /chats/:chatId/read` - отметить все сообщения в чате как прочитанные
   - `POST /messages/:messageId/read` - отметить конкретное сообщение как прочитанное
   - `GET /chats/:chatId/unread-count` - получить количество непрочитанных сообщений
4. **Обновленные запросы** - теперь возвращают информацию о прочитанных сообщениях и счетчики непрочитанных
5. **Исправленная логика статусов** - различает прочтение от лица текущего пользователя и собеседника

### Frontend изменения:
1. **Счетчик непрочитанных** в списке чатов (красный кружок с цифрой)
2. **Линия разделения** "Непрочитанные сообщения" в чате
3. **Правильные статусы прочтения**:
   - ✓ - сообщение доставлено (серый)
   - ✓✓ - сообщение прочитано собеседником (синий)
   - Статусы показываются только для ваших сообщений
4. **Автоматическое прочтение через 0.3 сек** как в Telegram
5. **Real-time обновления** счетчиков и списка чатов через WebSocket

## Функциональность

### Счетчик непрочитанных в ChatList:
- Показывает количество непрочитанных сообщений для каждого чата
- Обновляется в реальном времени при получении новых сообщений
- Обновляет последнее сообщение в списке чатов
- Обнуляется при входе в чат

### Линия разделения в чате:
- Отображается между последним прочитанным и первым непрочитанным сообщением
- Исчезает после прочтения всех сообщений

### Статусы прочтения (как в Telegram):
- **✓** - сообщение доставлено (серый цвет)
- **✓✓** - сообщение прочитано собеседником (синий цвет)
- Статусы отображаются только для ваших сообщений
- Показывают статус прочтения от лица собеседника

### Автоматическое прочтение:
- Сообщения автоматически отмечаются как прочитанные через 0.3 секунды после просмотра
- Срабатывает при скролле к концу чата (как в Telegram)
- Срабатывает при входе в чат
- Работает как для онлайн, так и для офлайн пользователей

### Real-time обновления:
- Список чатов обновляется мгновенно при получении новых сообщений
- Счетчики непрочитанных обновляются в реальном времени
- Статусы прочтения обновляются мгновенно
